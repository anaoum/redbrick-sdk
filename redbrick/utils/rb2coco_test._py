"""Test converting redbrick format to coco."""

import asyncio
from src.utils.rb2coco import rb2coco_single_image

width = 3000
height = 3000

data = [
    {
        "labels": [
            {
                "category": [["object", "bus"]],
                "attributes": [],
                "labelid": "19c41dce-000d-41fe-b790-67a2e96f2653",
                "point": {"xnorm": 0.4, "ynorm": 0.1},
            },
            {
                "category": [["object", "person"]],
                "attributes": [],
                "labelid": "8be93a94-1a2a-4c0a-a942-4edb7f1aaa8e",
                "bbox2d": {"xnorm": 0.4, "ynorm": 0.1, "wnorm": 0.2, "hnorm": 0.15,},
            },
            {
                "category": [["object", "bike"]],
                "attributes": [],
                "labelid": "3a03bd7c-8478-45a1-ab2a-edf9f50ed385",
                "polyline": [
                    {"xnorm": 0.4, "ynorm": 0.35},
                    {"xnorm": 0.6, "ynorm": 0.35},
                    {"xnorm": 0.9, "ynorm": 0.2},
                    {"xnorm": 0.9, "ynorm": 0.5},
                ],
            },
            {
                "category": [["object", "car"]],
                "attributes": [],
                "labelid": "e8a547f6-832c-4946-85cd-0c1a9b72fdbc",
                "polygon": [
                    {"xnorm": 0.5, "ynorm": 0.5},
                    {"xnorm": 0.3, "ynorm": 0.6},
                    {"xnorm": 0.35, "ynorm": 0.65},
                    {"xnorm": 0.6, "ynorm": 0.65},
                    {"xnorm": 0.7, "ynorm": 0.45},
                    {"xnorm": 0.6, "ynorm": 0.4},
                ],
            },
            {
                "category": [["object", "traffic sign"]],
                "attributes": [],
                "labelid": "5cee432d-50c7-4057-a5c4-4e53b327833e",
                "ellipse": {
                    "xcenternorm": 0.25,
                    "ycenternorm": 0.8,
                    "xnorm": 0.15,
                    "ynorm": 0.05,
                    "rot": 0.2,
                },
            },
            # {
            #     "category": [["object", "train"]],
            #     "attributes": [],
            #     "labelid": "a56047ea-62d9-480a-b801-5b8f31973977",
            #     "pixel": {
            #         "imagesize": [width, height],
            #         "regions": [
            #             [[303, 689], [303, 447], [545, 447], [545, 689]],
            #             [[307, 1101], [307, 859], [549, 859], [549, 1101]],
            #         ],
            #         "holes": [[[496, 1044], [496, 916], [368, 916], [368, 1044]]],
            #     },
            # },
        ],
        "items": ["http://datasets.redbrickai.com/lung/CHNCXR_0022_0.jpg"],
        "itemsPresigned": ["http://datasets.redbrickai.com/lung/CHNCXR_0022_0.jpg"],
        "name": "http://datasets.redbrickai.com/lung/CHNCXR_0022_0.jpg",
        "dpId": "9da9504b-eae3-4e20-bec0-5e1cb56fcefa",
        "createdBy": "derek@redbrickai.com",
    }
]


expected_result = {
    "info": {
        "year": "2021",
        "version": "1",
        "description": "Exported from redbrickai.com",
        "contributor": "RedBrick AI",
        "url": "https://app.redbrickai.com/orgid/projects/projectId/data",
        "date_created": "2021-01-01T00:00:00+00:00",
    },
    "licenses": [
        {
            "id": 1,
            "url": "https://creativecommons.org/publicdomain/zero/1.0/",
            "name": "License Unknown",
        }
    ],
    "images": [
        {
            "id": 0,
            "license": 1,
            "file_name": "9da9504b-eae3-4e20-bec0-5e1cb56fcefa",
            "redbrick_url": "https://app.redbrickai.com/<orgid>/projects/<projectid>/tasks/<taskId>",
            "height": height,
            "width": width,
        }
    ],
    "annotations": [
        {
            "id": 0,
            "image_id": 0,
            "category_id": 0,
            "is_crowd": 0,
            "keypoints": [0.4 * width, 0.1 * height, 0],
            "num_keypoints": 1,
            "area": 0,
            "bbox": [0.4 * width, 0.1 * height, 0, 0],
        },
        {
            "id": 1,
            "image_id": 0,
            "category_id": 3,
            "is_crowd": 0,
            "bbox": [0.4 * width, 0.1 * height, 0.2 * width, 0.15 * height],
            "area": 0.2 * 0.15 * width * height,
        },
        {
            "id": 2,
            "image_id": 0,
            "category_id": 4,
            "is_crowd": 0,
            "polyline": [
                0.4 * width,
                0.35 * height,
                0.6 * width,
                0.35 * height,
                0.9 * width,
                0.2 * height,
                0.9 * width,
                0.5 * height,
            ],
            "area": 0,
            "bbox": [0.4 * width, 0.2 * height, 0.5 * width, 0.3 * height],
        },
        {
            "id": 3,
            "image_id": 0,
            "category_id": 7,
            "is_crowd": 0,
            "segment": [
                [
                    0.5 * width,
                    0.5 * height,
                    0.3 * width,
                    0.6 * height,
                    0.35 * width,
                    0.65 * height,
                    0.6 * width,
                    0.65 * height,
                    0.7 * width,
                    0.45 * height,
                    0.6 * width,
                    0.4 * height,
                ]
            ],
            "bbox": [0.3 * width, 0.4 * height, 0.4 * width, 0.25 * height],
            "area": 461250,
        },
        {
            "id": 4,
            "image_id": 0,
            "category_id": 2,
            "is_crowd": 0,
            "ellipse": [0.25 * width, 0.8 * height, 0.15 * width, 0.05 * height, 0.2],
        },
        # {
        #     "id": 5,
        #     "image_id": 0,
        #     "category_id": 8,
        #     "is_crowd": 0,
        #     "segmentation": {"size": [width, height], "counts": []},
        #     "area": 1,
        #     "bbox": [100, 100, 100, 100],
        # },
    ],
    "categories": [
        {"name": "bus", "id": 0},
        {"name": "traffic light", "id": 1},
        {"name": "traffic sign", "id": 2},
        {"name": "person", "id": 3},
        {"name": "bike", "id": 4},
        {"name": "truck", "id": 5},
        {"name": "motor", "id": 6},
        {"name": "car", "id": 7},
        {"name": "train", "id": 8},
        {"name": "rider", "id": 9},
    ],
}


def test_rb2coco_single_image() -> None:
    """Test converting single image to coco format."""
    # arrange
    input_ = data[0]

    # action
    asyncio.run(rb2coco_single_image(input_, 0))
